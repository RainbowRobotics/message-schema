name: after-backend-deploy
on:
  workflow_run:
    workflows: ["backend-deploy"] # 위에 올려준 그 워크플로우 이름
    types: [completed]

permissions:
  actions: write
  contents: read

concurrency:
  group: after-backend-deploy-group
  cancel-in-progress: true

jobs:
  start:
    runs-on: self-hosted

    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v3

      - name: Download trigger tag from upstream run
        uses: actions/download-artifact@v4
        with:
          name: backend-deploy-branch
          run-id: ${{ github.event.workflow_run.id }}

      - name: Get Branch Name
        run: |
          BRANCH_NAME=$(cat backend_deploy_branch.txt)
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Get Service Names
        run: |
          for dir in backend/services/*/; do
            if [ -d "${dir}" ]; then
                # 디렉토리 경로에서 앱 이름만 추출
                APP_NAME=$(basename "${dir}")
                if [[ ! " ${APP_NAMES[@]} " =~ " ${APP_NAME} " ]]; then
                    APP_NAMES+=("$APP_NAME")
                fi
            fi
          done

          echo "APP_NAMES=$APP_NAMES" >> $GITHUB_ENV

      - name: Get Version
        run: |
          git fetch --tags --force --prune --quiet

          if [[ "$BRANCH_NAME" = "main" ]]; then
            TAG_NAME="$(git tag --list "release/total/*" --sort=-v:refname | head -n 1 || true)"
          else
            TAG_NAME="$(git tag --list "release/dev-total/*" --sort=-v:refname | head -n 1 || true)"
          fi

          if [[ -z "${TAG_NAME}" ]]; then
            echo "⚠️  매칭되는 태그 없음(패턴: release/total/* or release/dev-total/*)"
            exit 1
          else
            VERSION="${TAG_NAME##*/}"
          fi

          echo "TAG_NAME=${TAG_NAME}"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"

      - name: Download dist file from s3
        run: |
          S3_BASE_URL="https://rainbow-deploy.s3.ap-northeast-2.amazonaws.com/robot-repeater-server/$BRANCH_NAME"
