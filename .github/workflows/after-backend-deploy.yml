name: after-backend-deploy
on:
  repository_dispatch:
    types: [post-deploy]

permissions:
  actions: write
  contents: read

jobs:
  start:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v3

      - name: Get Branch Name
        run: |
          BRANCH_NAME=${{ github.event.client_payload.BRANCH_NAME }}

          git switch $BRANCH_NAME
          git pull origin $BRANCH_NAME

          git fetch --tags --force --prune --quiet

          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Get Service Names
        run: |
          for dir in backend/services/*/; do
            if [ -d "${dir}" ]; then
                # 디렉토리 경로에서 앱 이름만 추출
                APP_NAME=$(basename "${dir}")
                if [[ ! " ${APP_NAMES[@]} " =~ " ${APP_NAME} " ]]; then
                    APP_NAMES+=("$APP_NAME")
                fi
            fi
          done

          echo "APP_NAMES=$APP_NAMES" >> $GITHUB_ENV

      - name: Get Version
        run: |
          git fetch --tags --force --prune --quiet

          if [[ "$BRANCH_NAME" = "main" ]]; then
            TAG_NAME="$(git tag --list "release/total/*" --sort=-v:refname | head -n 1 || true)"
          else
            TAG_NAME="$(git tag --list "release/dev-total/*" --sort=-v:refname | head -n 1 || true)"
          fi

          if [[ -z "${TAG_NAME}" ]]; then
            echo "⚠️  매칭되는 태그 없음(패턴: release/total/* or release/dev-total/*)"
            exit 1
          else
            VERSION="${TAG_NAME##*/}"
          fi

          echo "TAG_NAME=${TAG_NAME}"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"

      - name: Download dist file from s3
        run: |
          S3_BASE_URL="https://rainbow-deploy.s3.ap-northeast-2.amazonaws.com/robot-repeater-server/${{ env.BRANCH_NAME }}"
