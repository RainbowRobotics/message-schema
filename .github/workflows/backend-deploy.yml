name: release-deploy

on:
  push:
    tags:
      - "deploy/**"
      - "deploy_hotfix/**"

permissions:
  contents: write

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v3

      - name: Get Hotfix Flag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          RELEASE_TYPE=$(echo $TAG_NAME | cut -d'/' -f1)
          echo "RELEASE_TYPE=$RELEASE_TYPE" >> $GITHUB_ENV
          if [ "$RELEASE_TYPE" == "deploy_hotfix" ]; then
            echo "HOTFIX=true" >> $GITHUB_ENV
          else
            echo "HOTFIX=false" >> $GITHUB_ENV
          fi

      - name: Get App Name
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          APP_NAME=$(echo $TAG_NAME | cut -d'/' -f2)
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV

      - name: Get Branch Name
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BRANCH_NAME=$(echo $TAG_NAME | cut -d'/' -f3)
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Get Release Version
        id: get_release_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=$(echo $TAG_NAME | cut -d'/' -f4)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Check App Directory and dist file
        run: |
          APP_DIR="backend/services/${{ env.APP_NAME }}"
          API_GATEWAY_DIR="api-gateway"

          ls -al

          ls -al $APP_DIR

          if [ ! -d "$APP_DIR" ]; then
            echo "Error: ${{ env.APP_NAME }} directory not found: $APP_DIR"
            exit 1
          fi

          if [ ! -d "$API_GATEWAY_DIR" ]; then
            echo "Error: API Gateway directory not found: $API_GATEWAY_DIR"
            exit 1
          fi

          if [ ! -f "$APP_DIR/${{ env.APP_NAME }}.arm64.bin" ] || [ ! -f "$APP_DIR/${{ env.APP_NAME }}.amd64.bin" ]; then
            echo "Error: bin file not found: $APP_DIR/${{ env.APP_NAME }}.arm64.bin or $APP_DIR/${{ env.APP_NAME }}.amd64.bin"
            exit 1
          fi

      - name: Compress bin directory
        run: |
          rm -rf dist
          mkdir -p dist
          mkdir -p dist/scripts

          cp -R backend/services/${{ env.APP_NAME }}/${{ env.APP_NAME }}.arm64.bin dist/
          cp -R backend/services/${{ env.APP_NAME }}/${{ env.APP_NAME }}.amd64.bin dist/
          cp -R backend/services/${{ env.APP_NAME }}/config.env dist/

          cp -R scripts/production-entrypoint.sh dist/scripts/

          cp -R Dockerfile.prod dist/

          cd dist

          zip -r "../${{ env.VERSION }}.zip" .

          cd ../api-gateway

          zip -r "../api-gateway.zip" .

          cd $GITHUB_WORKSPACE

          ls -al

      - name: Upload dist file to s3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-2

        run: |
          S3_BUCKET="rainbow-deploy"
          S3_PREFIX="robot-repeater-server/${{ env.BRANCH_NAME }}"
          S3_SERVICE_PATH="$S3_PREFIX/${{ env.APP_NAME }}"
          API_GATEWAY_FILE_NAME="api-gateway.zip"
          FILE_NAME="${{ env.VERSION }}.zip"

          # í˜„ì¬ ë””ë ‰í† ë¦¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (VERSION ë””ë ‰í† ë¦¬)
          DIRS=$(aws s3 ls "s3://$S3_BUCKET/$S3_SERVICE_PATH/" | grep "\.zip$" | awk '{print $4}')

          DIR_COUNT=$(echo "$DIRS" | wc -l)
          echo "í˜„ì¬ ë²„ì „ íŒŒì¼ ê°œìˆ˜: $DIR_COUNT"

          if [ "$DIR_COUNT" -ge 10 ]; then
            DELETE_COUNT=$(($DIR_COUNT - 9))
            echo "$DELETE_COUNT ê°œ ë²„ì „ íŒŒì¼ ì‚­ì œ ì˜ˆì •"

            DELETE_DIRS=$(echo "$DIRS" | sort | head -n $DELETE_COUNT)

            for FILE in $DELETE_DIRS; do
              echo "ì‚­ì œ: $FILE"
              aws s3 rm "s3://$S3_BUCKET/$S3_SERVICE_PATH/$FILE"
            done
          else
            echo "ì‚­ì œí•  ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi

          aws s3 cp "$FILE_NAME" "s3://$S3_BUCKET/$S3_SERVICE_PATH/$FILE_NAME"
          aws s3 cp "$API_GATEWAY_FILE_NAME" "s3://$S3_BUCKET/$S3_PREFIX/api-gateway.zip"

          HOTFIX_LINE=""
          if [ "${{ env.HOTFIX }}" == "true" ]; then
            HOTFIX_LINE=", \"hotfix\": true"
          fi

           # S3ì—ì„œ version.json íŒŒì¼ í™•ì¸ ë° ìƒì„±/ê°±ì‹ 
          if aws s3 ls "s3://$S3_BUCKET/$S3_SERVICE_PATH/version.json" > /dev/null 2>&1; then
            aws s3 cp "s3://$S3_BUCKET/$S3_SERVICE_PATH/version.json" version.json.tmp
            
            if [ -f version.json.tmp ]; then
              if [ "${HOTFIX:-false}" = "true" ]; then
                sed -E "s/\"new_version\": *\"[^\"]*\"/\"new_version\": \"${VERSION}\", \"hotfix\": true/" version.json.tmp \
                  > version.json.new
              else
                sed -E "s/\"new_version\": *\"[^\"]*\"/\"new_version\": \"${VERSION}\"/" version.json.tmp \
                  | sed -E "s/, *\"hotfix\": *true//" \
                  > version.json.new
              fi
            else
              # ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
              if [ "${HOTFIX:-false}" = "true" ]; then
                echo "{\"new_version\": \"${VERSION}\", \"hotfix\": true}" > version.json.new
              else
                echo "{\"new_version\": \"${VERSION}\"}" > version.json.new
              fi
            fi


            aws s3 cp version.json.new "s3://$S3_BUCKET/$S3_SERVICE_PATH/version.json" --content-type application/json
            rm -f version.json.tmp version.json.new
          else
            # íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            echo "{\"new_version\": \"${{ env.VERSION }}\"$HOTFIX_LINE}" > version.json.new
            aws s3 cp version.json.new "s3://$S3_BUCKET/$S3_SERVICE_PATH/version.json"
            rm -f version.json.new
          fi
      - name: Clone release apps repository
        env:
          GH_TOKEN: ${{ secrets.RAINBOW_RELEASE_APPS_TOKEN }}
        run: |
          BRANCH_NAME=${{ env.BRANCH_NAME }}
          REPO_URL="https://$GH_TOKEN@github.com/rainbow-mobile/rainbow-release-apps.git"

          # ë¸Œëœì¹˜ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if git ls-remote --heads "$REPO_URL" "$BRANCH_NAME" | grep "$BRANCH_NAME" > /dev/null; then
            echo "âœ… ë¸Œëœì¹˜ $BRANCH_NAME ì¡´ì¬ â†’ shallow clone"
            git clone --depth 1 --branch "$BRANCH_NAME" --single-branch "$REPO_URL" rainbow-release-apps
          else
            echo "ğŸŒ± ë¸Œëœì¹˜ $BRANCH_NAME ì—†ìŒ â†’ empty ë¸Œëœì¹˜ë¡œë¶€í„° ìƒì„±"
            git clone --depth 1 --branch empty --single-branch "$REPO_URL" rainbow-release-apps
            cd rainbow-release-apps
            git checkout -b "$BRANCH_NAME"
            git push origin "$BRANCH_NAME"
            cd ..
          fi

      - name: Copy and commit build / api-gateway
        env:
          GH_TOKEN: ${{ secrets.RAINBOW_RELEASE_APPS_TOKEN }}
        run: |
          cd rainbow-release-apps
          APP_DIR="robot-repeater-server/${{ env.APP_NAME }}"

          # ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ìƒì„±
          mkdir -p "$APP_DIR"

          # hotfix ì—¬ë¶€ í™•ì¸
          HOTFIX_LINE=""
          if [ "${{ env.HOTFIX }}" == "true" ]; then
            HOTFIX_LINE=", \"hotfix\": true"
          fi

           # version.json íŒŒì¼ ìƒì„±/ê°±ì‹ 
          echo "{\"new_version\": \"${{ env.VERSION }}\"$HOTFIX_LINE}" > "$APP_DIR/version.json"

          # í˜„ì¬ ë²„ì „ ë””ë ‰í† ë¦¬ ìˆ˜ í™•ì¸ ë° ì •ë¦¬
          DIR_COUNT=$(ls -1 "$APP_DIR" | wc -l)
          if [ "$DIR_COUNT" -ge 10 ]; then
            OLDEST_DIR=$(ls -1 "$APP_DIR" | sort -V | head -n 1)
            rm -rf "$APP_DIR/$OLDEST_DIR"
          fi

          # ì„œë¹„ìŠ¤ ì••ì¶•íŒŒì¼ ì´ë™
          mkdir -p "$APP_DIR/${{ env.VERSION }}"
          mv ../${{ env.VERSION }}.zip "$APP_DIR/"

          # api-gateway ì••ì¶•íŒŒì¼ ì´ë™
          rm -f "robot-repeater-server/api-gateway.zip"
          mv ../api-gateway.zip "robot-repeater-server/"

          rm -f ../${{ env.VERSION }}.zip
          rm -f ../api-gateway.zip

          ls -al

          # ìƒˆ ë²„ì „ ë°°í¬
          git config --global user.email "dfd1123@naver.com"
          git config --global user.name "dfd1123"
          git add .
          git commit -m "Release App:${{ env.APP_NAME }}, Version: ${{ env.VERSION }}"
          git remote set-url origin https://$GH_TOKEN@github.com/rainbow-mobile/rainbow-release-apps.git
          git push origin ${{ env.BRANCH_NAME }}

      - name: Delete release tag
        if: always()
        env:
          GH_TOKEN: ${{ secrets.RAINBOW_RELEASE_APPS_TOKEN }}
        run: |
          cd $GITHUB_WORKSPACE

          # íƒœê·¸ ì‚­ì œ
          git push origin --delete "${{ env.RELEASE_TYPE }}/${{ env.APP_NAME }}/${{ env.BRANCH_NAME }}/${{ env.VERSION }}"
