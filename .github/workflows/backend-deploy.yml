name: backend-deploy

on:
  push:
    tags:
      - "deploy/**"
      - "deploy_hotfix/**"

permissions:
  contents: write

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v3

      - name: Get Hotfix Flag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          RELEASE_TYPE=$(echo $TAG_NAME | cut -d'/' -f1)
          echo "RELEASE_TYPE=$RELEASE_TYPE" >> $GITHUB_ENV
          if [ "$RELEASE_TYPE" == "deploy_hotfix" ]; then
            echo "HOTFIX=true" >> $GITHUB_ENV
          else
            echo "HOTFIX=false" >> $GITHUB_ENV
          fi

      - name: Get Service Names
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          SERVICE_NAMES=$(echo $TAG_NAME | cut -d'/' -f2)
          if [ "$SERVICE_NAMES" = "all" ]; then
            SERVICE_ARRAY=$(ls -1d backend/services/*/ | xargs -n1 basename | tr '\n' ' ')
          else
            SERVICE_ARRAY=$(echo "$SERVICE_NAMES" | tr '__' ' ')
          fi

          SERVICE_ARRAY=$(echo "$SERVICE_ARRAY" | tr -s ' ')

          echo "SERVICE_LIST=$SERVICE_ARRAY" >> "$GITHUB_ENV"
          echo "SERVICE_NAMES=$SERVICE_NAMES" >> "$GITHUB_ENV"

      - name: Get Branch Name
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BRANCH_NAME=$(echo $TAG_NAME | cut -d'/' -f3)
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Get Release Version
        id: get_release_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=$(echo $TAG_NAME | cut -d'/' -f4)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Check service directory and build binary file
        run: |
          IFS=' ' read -r -a SERVICE_ARRAY <<< "$SERVICE_LIST"

          for SERVICE in "${SERVICE_ARRAY[@]}"; do
            APP_DIR="backend/services/${SERVICE}"

            if [ ! -d "$APP_DIR" ]; then
              echo "Error: ${SERVICE} directory not found: $APP_DIR"
              exit 1
            fi

            if [ ! -f "$APP_DIR/${SERVICE}.arm64.bin" ] || [ ! -f "$APP_DIR/${SERVICE}.amd64.bin" ]; then
              echo "Error: bin file not found: $APP_DIR/${SERVICE}.arm64.bin or $APP_DIR/${SERVICE}.amd64.bin"
              exit 1
            fi

            if [ ! -f "$APP_DIR/config.env" ]; then
              echo "Error: config.env file not found: $APP_DIR/config.env"
              exit 1
            fi
          done

          API_GATEWAY_DIR="api-gateway"

          if [ ! -d "$API_GATEWAY_DIR" ]; then
            echo "Error: API Gateway directory not found: $API_GATEWAY_DIR"
            exit 1
          fi

      - name: Compress bin directory
        run: |
          rm -rf dist
          mkdir -p dist
          mkdir -p dist/scripts
          mkdir -p dist/api-gateway

          IFS=' ' read -r -a SERVICE_ARRAY <<< "$SERVICE_LIST"

          for SERVICE in "${SERVICE_ARRAY[@]}"; do
            mkdir -p dist/${SERVICE}
            APP_DIR="backend/services/${SERVICE}"

            cp -R $APP_DIR/${SERVICE}.arm64.bin dist/${SERVICE}
            cp -R $APP_DIR/${SERVICE}.amd64.bin dist/${SERVICE}
            cp -R $APP_DIR/config.env dist/${SERVICE}
          done

          cp -R api-gateway/nginx.conf dist/api-gateway
          cp -R api-gateway/watchdog.sh dist/api-gateway
          cp -R api-gateway/Dockerfile dist/api-gateway

          cp -R scripts/backend/production-entrypoint.sh dist/scripts/

          cp -R backend/Dockerfile.prod dist/

          cd dist

          zip -r "../${{ env.VERSION }}.zip" .

          cd $GITHUB_WORKSPACE

          ls -a

      - name: Make version.json
        run: |
          HOTFIX_LINE=""
          if [ "${{ env.HOTFIX }}" == "true" ]; then
            HOTFIX_LINE=", \"hotfix\": true"
          fi

          echo "{\"new_version\": \"${{ env.VERSION }}\"$HOTFIX_LINE}" > version.json

      - name: Upload dist file to s3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-2

        run: |
          S3_BUCKET="rainbow-deploy"
          S3_PREFIX="robot-repeater-server/${{ env.BRANCH_NAME }}"

          FILE_NAME="${{ env.VERSION }}.zip"

          DIRS=$(aws s3 ls "s3://$S3_BUCKET/$S3_PREFIX/" | grep "\.zip$" | awk '{print $4}')

          DIR_COUNT=$(echo "$DIRS" | wc -l)
          echo "í˜„ì¬ ë²„ì „ íŒŒì¼ ê°œìˆ˜: $DIR_COUNT"

          if [ "$DIR_COUNT" -ge 10 ]; then
            DELETE_COUNT=$(($DIR_COUNT - 9))
            echo "$DELETE_COUNT ê°œ ë²„ì „ íŒŒì¼ ì‚­ì œ ì˜ˆì •"

            DELETE_DIRS=$(echo "$DIRS" | sort | head -n $DELETE_COUNT)

            for FILE in $DELETE_DIRS; do
              echo "ì‚­ì œ: $FILE"
              aws s3 rm "s3://$S3_BUCKET/$S3_PREFIX/$FILE"
            done
          else
            echo "ì‚­ì œí•  ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi

          aws s3 cp "$FILE_NAME" "s3://$S3_BUCKET/$S3_PREFIX/$FILE_NAME"

          aws s3 cp version.json "s3://$S3_BUCKET/$S3_PREFIX/version.json"

      - name: Create install.zip file
        run: |
          mkdir -p install

          BRANCH_NAME=${{ env.BRANCH_NAME }}
          VERSION=${{ env.VERSION }}

          sed "s/^BRANCH=.*/BRANCH=\"$BRANCH_NAME\"/" scripts/backend/s3-install.sh \
          | sed "s/^VERSION=.*/VERSION=\"$VERSION\"/" \
          > install/s3-install.sh

          chmod +x install/s3-install.sh

          (cd install && zip -r ../install.zip .)

          rm -rf install
      - name: Clone release apps repository
        env:
          GH_TOKEN: ${{ secrets.RAINBOW_RELEASE_APPS_TOKEN }}
        run: |
          BRANCH_NAME=${{ env.BRANCH_NAME }}
          REPO_URL="https://$GH_TOKEN@github.com/rainbow-mobile/rainbow-release-apps.git"

          # ë¸Œëœì¹˜ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if git ls-remote --heads "$REPO_URL" "$BRANCH_NAME" | grep "$BRANCH_NAME" > /dev/null; then
            echo "âœ… ë¸Œëœì¹˜ $BRANCH_NAME ì¡´ì¬ â†’ shallow clone"
            git clone --depth 1 --branch "$BRANCH_NAME" --single-branch "$REPO_URL" rainbow-release-apps
          else
            echo "ğŸŒ± ë¸Œëœì¹˜ $BRANCH_NAME ì—†ìŒ â†’ empty ë¸Œëœì¹˜ë¡œë¶€í„° ìƒì„±"
            git clone --depth 1 --branch empty --single-branch "$REPO_URL" rainbow-release-apps
            cd rainbow-release-apps
            git checkout -b "$BRANCH_NAME"
            git push origin "$BRANCH_NAME"
            cd ..
          fi

      - name: Copy and commit build / api-gateway
        env:
          GH_TOKEN: ${{ secrets.RAINBOW_RELEASE_APPS_TOKEN }}
        run: |
          cd rainbow-release-apps
          APP_DIR="robot-repeater-server"

          # ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ìƒì„±
          mkdir -p "$APP_DIR"
          mkdir -p "$APP_DIR/${{ env.VERSION }}"

          # í˜„ì¬ ë²„ì „ ë””ë ‰í† ë¦¬ ìˆ˜ í™•ì¸ ë° ì •ë¦¬
          DIR_COUNT=$(ls -1 "$APP_DIR" | wc -l)
          if [ "$DIR_COUNT" -ge 10 ]; then
            OLDEST_DIR=$(ls -1 "$APP_DIR" | sort -V | head -n 1)
            rm -rf "$APP_DIR/$OLDEST_DIR"
          fi

          mkdir -p "${APP_DIR}"
          mv ../install.zip "$APP_DIR/${{ env.VERSION }}.zip"

          ls -al

          IFS=' ' read -r -a SERVICE_ARRAY <<< "$SERVICE_LIST"

          JOINS_SERVICES=$(IFS=','; echo "${SERVICE_ARRAY[*]}")

          # ìƒˆ ë²„ì „ ë°°í¬
          git config --global user.email "dfd1123@naver.com"
          git config --global user.name "dfd1123"
          git add .
          git commit -m "Release App:robot-repeater-server, Service: [${JOINS_SERVICES}], Version: ${{ env.VERSION }}"
          git remote set-url origin https://$GH_TOKEN@github.com/rainbow-mobile/rainbow-release-apps.git
          git push origin ${{ env.BRANCH_NAME }}

      - name: Delete release tag
        if: always()
        env:
          GH_TOKEN: ${{ secrets.RAINBOW_RELEASE_APPS_TOKEN }}
        run: |
          cd $GITHUB_WORKSPACE

          # íƒœê·¸ ì‚­ì œ
          git push origin --delete "${{ env.RELEASE_TYPE }}/${{ env.SERVICE_NAMES }}/${{ env.BRANCH_NAME }}/${{ env.VERSION }}"

          rm -rf ./install.zip
          rm -rf ./version.json
          rm -rf ./${{ env.VERSION }}.zip
