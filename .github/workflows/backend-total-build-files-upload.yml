name: backend-total-build-files-upload
on:
  push:
    tags:
      - "release/total/**"
      - "release/dev-total/**"
  workflow_dispatch:
    inputs:
      branch_name:
        description: "BRANCH_NAME (ex: main, dev)"
        required: true
        default: "main"
      version:
        description: "VERSION (ex: 0.0.9)"
        required: true

permissions:
  actions: write
  contents: read

jobs:
  start:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v3

      - name: Get Branch Name
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BRANCH_NAME=${{ github.event.inputs.branch_name }}
          else
            TAG_NAME=${GITHUB_REF#refs/tags/}
            BRANCH_NAME=$(echo $TAG_NAME | cut -d'/' -f3)
          fi

          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Get Release Version
        id: get_release_version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION=${{ github.event.inputs.version }}
          else
            TAG_NAME=${GITHUB_REF#refs/tags/}
            VERSION=$(echo $TAG_NAME | cut -d'/' -f4)
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Download dist file from s3
        run: |

          S3_BASE_URL="https://rainbow-deploy.s3.ap-northeast-2.amazonaws.com/robot-repeater-server/${{ env.BRANCH_NAME }}"

          need() { command -v "$1" >/dev/null 2>&1 || return 0; }
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq í•„ìš”"; exit 127;
          fi
          if ! command -v unzip >/dev/null 2>&1; then           
            echo "unzip í•„ìš”"; exit 127;
          fi
          if ! command -v curl >/dev/null 2>&1; then
            echo "curl í•„ìš”"; exit 127;
          fi

          DIST="${{ env.VERSION }}"
          rm -rf "${DIST}"
          rm -rf "${DIST}.zip"

          mkdir -p "${DIST}"
          mkdir -p "${DIST}/services"
          mkdir -p "${DIST}/api-gateway"

          AGG_JSON="${DIST}/services/version.json"
          echo "{}" > "$AGG_JSON"

          shopt -s nullglob
          for dir in backend/services/*/; do
            app_name="$(basename "$dir")"

            app_ver_json_url="${S3_BASE_URL}/${app_name}/version.json"
            tmp_json="$(mktemp)"
            if ! curl -fsSL "$app_ver_json_url" -o "$tmp_json"; then
              echo "âš ï¸  ${app_name}: version.json ì—†ìŒ â†’ ìŠ¤í‚µ (${app_ver_json_url})"
              rm -f "$tmp_json"
              continue
            fi

            app_version="$(jq -er '.new_version' "$tmp_json")"
            rm -f "$tmp_json"

            if [[ -z "$app_version" || "$app_version" == "null" ]]; then
              echo "âš ï¸  ${app_name}: new_version í‚¤ê°€ ì—†ìŒ â†’ ìŠ¤í‚µ"
              exit 1
            fi

            tmp_agg="$(mktemp)"
            jq --arg k "$app_name" --arg v "$app_version" '.[$k]=$v' "$AGG_JSON" > "$tmp_agg"
            mv "$tmp_agg" "$AGG_JSON"

            zip_url="${S3_BASE_URL}/${app_name}/${app_version}.zip"
            tmp_zip="$(mktemp).zip"
            if ! curl -fsSL "$zip_url" -o "$tmp_zip"; then
              echo "â›”  ${app_name}: zip ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (${zip_url})"
              rm -f "$tmp_zip"
              exit 1
            fi

            target_dir="${DIST}/services/${app_name}"
            rm -rf "$target_dir"
            mkdir -p "$target_dir"
            unzip -q -o "$tmp_zip" -d "$target_dir"
            rm -f "$tmp_zip"

          done

          api_gateway_zip_url="${S3_BASE_URL}/api-gateway.zip"
          tmp_zip="$(mktemp).zip"
          if ! curl -fsSL "$api_gateway_zip_url" -o "$tmp_zip"; then
            echo "â›”  api-gateway: zip ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (${api_gateway_zip_url})"
            rm -f "$tmp_zip"
            exit 1
          fi

          target_dir="${DIST}/api-gateway"
          unzip -q -o "$tmp_zip" -d "$target_dir"
          rm -f "$tmp_zip"

          cat "$AGG_JSON"

          ( cd "${DIST}" && zip -qr "../${DIST}.zip" . )
           
          rm -rf "${DIST}"

      - name: Make version.json
        run: |
          echo "{\"new_version\": \"${{ env.VERSION }}\", \"branch\": \"${{ env.BRANCH_NAME }}\"}" > version.json

      - name: Upload dist file to s3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-2

        run: |
          S3_BUCKET="rainbow-deploy"
          S3_PREFIX="robot-repeater-server/${{ env.BRANCH_NAME }}"
          FILE_NAME="${{ env.VERSION }}.zip"

          # í˜„ì¬ ë””ë ‰í† ë¦¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (VERSION ë””ë ‰í† ë¦¬)
          DIRS=$(aws s3 ls "s3://$S3_BUCKET/$S3_PREFIX/" \
            | awk '$4 ~ /\.zip$/ && $4 != "api-gateway.zip" {print $4}')

          DIR_COUNT=$(echo "$DIRS" | wc -l)
          echo "í˜„ì¬ ë²„ì „ íŒŒì¼ ê°œìˆ˜: $DIR_COUNT"

          if [ "$DIR_COUNT" -ge 10 ]; then
            DELETE_COUNT=$(($DIR_COUNT - 9))
            echo "$DELETE_COUNT ê°œ ë²„ì „ íŒŒì¼ ì‚­ì œ ì˜ˆì •"

            DELETE_DIRS=$(echo "$DIRS" | sort | head -n $DELETE_COUNT)

            for FILE in $DELETE_DIRS; do
              echo "ì‚­ì œ: $FILE"
              aws s3 rm "s3://$S3_BUCKET/$S3_PREFIX/$FILE"
            done
          else
            echo "ì‚­ì œí•  ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi

          aws s3 cp "$FILE_NAME" "s3://$S3_BUCKET/$S3_PREFIX/$FILE_NAME"
          aws s3 cp "version.json" "s3://$S3_BUCKET/$S3_PREFIX/version.json"

      - name: Create install.sh file
        run: |
          mkdir -p install

          BRANCH_NAME=${{ env.BRANCH_NAME }}
          VERSION=${{ env.VERSION }}

          SRC="scripts/backend/s3-install.sh"
          DST="s3-install.sh"

          sed -e "s/^BRANCH=.*/BRANCH=\"$BRANCH_NAME\"/" \
              -e "s/^VERSION=.*/VERSION=\"$VERSION\"/" \
              "$SRC" > "$DST"


          chmod +x s3-install.sh

      - name: Clone release apps repository
        env:
          GH_TOKEN: ${{ secrets.RAINBOW_RELEASE_APPS_TOKEN }}
        run: |
          BRANCH_NAME=${{ env.BRANCH_NAME }}
          REPO_URL="https://$GH_TOKEN@github.com/rainbow-mobile/rainbow-release-apps.git"

          # ë¸Œëœì¹˜ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if git ls-remote --heads "$REPO_URL" "$BRANCH_NAME" | grep "$BRANCH_NAME" > /dev/null; then
            echo "âœ… ë¸Œëœì¹˜ $BRANCH_NAME ì¡´ì¬ â†’ shallow clone"
            git clone --depth 1 --branch "$BRANCH_NAME" --single-branch "$REPO_URL" rainbow-release-apps
          else
            echo "ğŸŒ± ë¸Œëœì¹˜ $BRANCH_NAME ì—†ìŒ â†’ empty ë¸Œëœì¹˜ë¡œë¶€í„° ìƒì„±"
            git clone --depth 1 --branch empty --single-branch "$REPO_URL" rainbow-release-apps
            cd rainbow-release-apps
            git checkout -b "$BRANCH_NAME"
            git push origin "$BRANCH_NAME"
            cd ..
          fi

      - name: Copy and commit build
        env:
          GH_TOKEN: ${{ secrets.RAINBOW_RELEASE_APPS_TOKEN }}
        run: |
          cd rainbow-release-apps
          APP_DIR="robot-repeater-server"

          VERSION=${{ env.VERSION }}
          BRANCH=${{ env.BRANCH_NAME }}

          rm -rf "${APP_DIR}/${VERSION}"

          # ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ìƒì„±
          mkdir -p "$APP_DIR"
          mkdir -p "${APP_DIR}/${VERSION}"

          mapfile -t TOTAL_BUILD_DIRS < <(find "$TARGET" -maxdepth 1 -type f -name '*.zip' \
            ! -name 'api-gateway.zip' -printf '%f\n' 2>/dev/null || \
            find "$TARGET" -maxdepth 1 -type f -name '*.zip' ! -name 'api-gateway.zip' -exec basename {} \;)

          # í˜„ì¬ ë²„ì „ ë””ë ‰í† ë¦¬ ìˆ˜ í™•ì¸ ë° ì •ë¦¬
          DIR_COUNT=$(ls -1 "$TOTAL_BUILD_DIRS" | wc -l)
          if [ "$DIR_COUNT" -ge 10 ]; then
            OLDEST_DIR=$(ls -1 "$TOTAL_BUILD_DIRS" | sort -V | head -n 1)
            rm -rf "$APP_DIR/$OLDEST_DIR"
          fi

          # version.json ì´ë™
          rm -rf "$APP_DIR/version.json"
          mv ../version.json "$APP_DIR/version.json"

          # install.sh ì´ë™
          mv ../s3-install.sh "${APP_DIR}/${VERSION}/s3-install.sh"

          (cd "$APP_DIR" && zip -qr -X -FS "${VERSION}.zip" "${VERSION}")

          rm -rf "${APP_DIR}/${VERSION}"


          ls -al

          # ìƒˆ ë²„ì „ ë°°í¬
          git config --global user.email "dfd1123@naver.com"
          git config --global user.name "dfd1123"
          git add .
          git commit -m "Release Total Apps, Branch: ${BRANCH}, Version: ${VERSION}, Download: (https://rainbow-deploy.s3.ap-northeast-2.amazonaws.com/robot-repeater-server/${BRANCH}/${VERSION}.zip)"
          git remote set-url origin https://$GH_TOKEN@github.com/rainbow-mobile/rainbow-release-apps.git
          git push origin ${BRANCH}

      - name: Delete release tag
        if: always()
        run: |
          cd $GITHUB_WORKSPACE

          DIST="${{ env.VERSION }}"

          rm -rf "${DIST}.zip"
          rm -rf "version.json"
          rm -rf "s3-install.sh"
