name: delete-branch-and-build-file

on: delete

permissions:
  contents: write

jobs:
  clean-up-s3:
    if: github.event.ref_type == 'branch'
    runs-on: self-hosted

    steps:
      - name: Get Branch Name
        run: |
          BRANCH_NAME=${{ github.event.ref }}
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Cleanup S3 build for deleted branch
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-2
        run: |
          S3_BUCKET="rainbow-deploy"
          S3_PREFIX="robot-repeater-server/${{ env.BRANCH_NAME }}/"

          aws s3 rm "s3://$S3_BUCKET/$S3_PREFIX" --recursive || echo "âš ï¸ ì‚­ì œí•  S3 ê²½ë¡œ ì—†ìŒ, SKIP!"

      - name: Delete Release App and Branch
        env:
          GH_TOKEN: ${{ secrets.RAINBOW_APPS_DEPLOY_TOKEN }}
        run: |
          git clone https://$GH_TOKEN@github.com/rainbow-mobile/rainbow-release-apps.git
          cd rainbow-release-apps

          rm -rf robot-repeater-server

          # ì›í•˜ëŠ” ë¸Œëœì¹˜ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ìˆìœ¼ë©´ ì²´í¬ì•„ì›ƒ
          if git ls-remote --heads origin ${{ env.BRANCH_NAME }} | grep ${{ env.BRANCH_NAME }}; then
              git checkout ${{ env.BRANCH_NAME }}

              if [ -d "robot-repeater-server" ]; then
                  rm -rf robot-repeater-server
              fi

              git config --global user.email "dfd1123@naver.com"
              git config --global user.name "dfd1123"

              git add .
              git commit -m "Delete robot-repeater-server for branch: ${{ env.BRANCH_NAME }}" || echo "Nothing to commit"
              git push origin ${{ env.BRANCH_NAME }}

              CLEAN_COUNT=$(find . -mindepth 1 -maxdepth 1 -type d ! -name '.github' | wc -l)

              if [ "$CLEAN_COUNT" -eq 0 ]; then
                  echo "ğŸ—‘ï¸ ë¸Œëœì¹˜ì— ë‚¨ì€ íŒŒì¼ ì—†ìŒ â†’ ë¸Œëœì¹˜ ì‚­ì œ ì‹œë„"
                  git push origin --delete ${{ env.BRANCH_NAME }} || echo "âš ï¸ ë¸Œëœì¹˜ ì‚­ì œ ì‹¤íŒ¨"
              else
                  echo "âš ï¸ ë¸Œëœì¹˜ì— íŒŒì¼ ë‚¨ì•„ìˆìŒ â†’ ì‚­ì œ ì•ˆ í•¨"
              fi
          else
              echo "âš ï¸ ë¸Œëœì¹˜ ${{ env.BRANCH_NAME }} ì—†ìŒ, SKIP!"
          fi

          cd ..
