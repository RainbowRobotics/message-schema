name: Auto PR from team push (schema/from-*)
on:
  push:
    branches:
      - "schema/from-*"
permissions:
  contents: read
  pull-requests: write

jobs:
  pull-request-to-main:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 1
          
      - name: Check PR exists
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.RB_MSG_SCHEMA_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -e
          EXIST=$(gh pr list --repo "$REPO" --head "$BRANCH" --json number --jq 'length')
          if [ "$EXIST" -gt 0 ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            PR_NUMBER=$(gh pr list --repo "$REPO" --head "$BRANCH" --json number --jq '.[0].number')
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            echo "PR already exists for $BRANCH (#$PR_NUMBER)"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "No PR for $BRANCH"
          fi

      - name: Get changed files
        id: changed_files
        env:
          GH_TOKEN: ${{ secrets.RB_MSG_SCHEMA_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          BEFORE: ${{ github.event.before }}
        run: |
          set -euo pipefail
          
          echo "=== Getting changed files from GitHub API ==="
          
          PR_NUMBER=$(gh pr list --repo "$REPO" --head "$BRANCH" --json number --jq '.[0].number // empty')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "Found existing PR #$PR_NUMBER"
            CHANGED_FILES=$(gh pr view "$PR_NUMBER" \
              --repo "$REPO" \
              --json files --jq '.files[].path')
          else
            echo "No PR found, comparing commits"
            echo "Comparing: $BEFORE...$SHA"
            
            if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
              echo "New branch detected, using current commit only"
              CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
            else
              CHANGED_FILES=$(gh api \
                "/repos/$REPO/compare/$BEFORE...$SHA" \
                --jq '.files[].filename' 2>/dev/null || echo "")
              
              if [ -z "$CHANGED_FILES" ]; then
                echo "API comparison failed, using current commit"
                CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
              fi
            fi
          fi
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "WARNING: Could not detect any changed files"
            echo "dirs=root" >> "$GITHUB_OUTPUT"
            echo "" > /tmp/changed_files.txt
            exit 0
          fi
          
          echo "=== Changed files ==="
          echo "$CHANGED_FILES"
          echo "$CHANGED_FILES" > /tmp/changed_files.txt
          
          CHANGED_DIRS=$(echo "$CHANGED_FILES" \
            | awk -F/ '{if (NF==1) print "root"; else print $1}' \
            | sort -u \
            | tr '\n' ' ' \
            | sed 's/^ *//; s/ *$//')
          
          echo "=== Changed directories ==="
          echo "[$CHANGED_DIRS]"
          echo "dirs=$CHANGED_DIRS" >> "$GITHUB_OUTPUT"

      - name: Parse CODEOWNERS and get mentions
        id: get_mentions
        run: |
          set -e
          CODEOWNERS_FILE=".github/CODEOWNERS"
          MAPPING_FILE=".github/slack-mentions.json"
          
          if [ ! -f "$CODEOWNERS_FILE" ]; then
            echo "CODEOWNERS file not found"
            echo "mentions=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          if [ ! -f "$MAPPING_FILE" ]; then
            echo "Slack mapping file not found: $MAPPING_FILE"
            echo "mentions=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          CHANGED_FILES="$(cat /tmp/changed_files.txt 2>/dev/null || true)"
          if [ -z "${CHANGED_FILES// }" ]; then
            echo "No changed files"
            echo "mentions=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq not found on runner"
            echo "mentions=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          : > /tmp/mentions.txt
          
          echo "=== Matching CODEOWNERS ==="
          
          # CODEOWNERS 파싱
          while IFS= read -r line; do
            # 주석/빈줄 제외
            [[ "$line" =~ ^#.*$ ]] && continue
            [[ -z "${line// }" ]] && continue
            
            PATTERN="$(echo "$line" | awk '{print $1}')"
            OWNERS="$(echo "$line" | cut -d' ' -f2-)"
            
            # 패턴 정규화
            PATTERN_CLEAN="${PATTERN#/}"        # 앞의 / 제거
            PATTERN_BASE="${PATTERN_CLEAN%/\*\*}"  # /** 제거
            PATTERN_BASE="${PATTERN_BASE%/\*}"     # /* 제거
            
            # 파일 매칭
            while IFS= read -r file; do
              [[ -z "$file" ]] && continue
              
              MATCHED=false
              
              # 패턴 타입별 매칭
              if [[ "$PATTERN" == *"**" ]]; then
                # /** 패턴: 디렉토리 하위 모든 파일
                if [[ "$file" == "$PATTERN_BASE"* ]]; then
                  MATCHED=true
                fi
              elif [[ "$PATTERN" == *"*" ]]; then
                # /* 패턴: 디렉토리 바로 하위 파일만
                if [[ "$file" == "$PATTERN_BASE"/* ]] && [[ ! "$file" =~ $PATTERN_BASE/.+/.+ ]]; then
                  MATCHED=true
                fi
              else
                # 정확한 파일명
                if [[ "$file" == "$PATTERN_CLEAN" ]]; then
                  MATCHED=true
                fi
              fi
              
              if [ "$MATCHED" = true ]; then
                echo "  ✓ $file -> $PATTERN (owners: $OWNERS)"
                for owner in $OWNERS; do
                  jq -r --arg key "$owner" '.[$key] // empty | .[]' "$MAPPING_FILE" >> /tmp/mentions.txt 2>/dev/null || true
                done
              fi
            done <<< "$CHANGED_FILES"
          done < "$CODEOWNERS_FILE"
          
          MENTIONS="$(sort -u /tmp/mentions.txt 2>/dev/null | tr '\n' ' ' | sed 's/ */ /g' | sed 's/^ *//; s/ *$//')"
          echo "=== Final mentions ==="
          echo "$MENTIONS"
          echo "mentions=$MENTIONS" >> "$GITHUB_OUTPUT"

      - name: Create PR
        id: create_pr
        if: steps.check_pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.RB_MSG_SCHEMA_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -e
          PR_URL=$(gh pr create \
            --repo "$REPO" \
            --base main \
            --head "$BRANCH" \
            --title "schema: update from $BRANCH" \
            --body "Auto-created PR from team repo push: $BRANCH" \
            2>&1) || {
            echo "PR create failed; checking if PR now exists..."
            EXIST=$(gh pr list --repo "$REPO" --head "$BRANCH" --json number --jq 'length')
            if [ "$EXIST" -gt 0 ]; then
              PR_NUMBER=$(gh pr list --repo "$REPO" --head "$BRANCH" --json number --jq '.[0].number')
              PR_URL="https://github.com/$REPO/pull/$PR_NUMBER"
              echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
              echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
              exit 0
            else
              exit 1
            fi
          }
          
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
          echo "Created PR #$PR_NUMBER"

      - name: Send Slack Notification (Created PR)
        if: steps.create_pr.outputs.pr_number != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PR_NUMBER: ${{ steps.create_pr.outputs.pr_number }}
          PR_URL: ${{ steps.create_pr.outputs.pr_url }}
          MENTIONS: ${{ steps.get_mentions.outputs.mentions }}
          CHANGED_DIRS: ${{ steps.changed_files.outputs.dirs }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          SHA: ${{ github.sha }}
          STATUS: ${{ job.status }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          set -e
          
          DIR_LIST=$(printf "%s\n" "$CHANGED_DIRS" \
            | tr ' ' '\n' \
            | sed '/^$/d' \
            | awk '{print "• `" $0 "`"}' \
            | paste -sd '\n' -)
          [ -z "$DIR_LIST" ] && DIR_LIST="• (변경사항 확인 중)"
          
          BLOCKS=$(jq -n \
            --arg repo "$REPO" \
            --arg branch "$BRANCH" \
            --arg status "$STATUS" \
            --arg pr_url "$PR_URL" \
            --arg pr_number "$PR_NUMBER" \
            --arg dirs "$DIR_LIST" \
            --arg commit "$COMMIT_MESSAGE" \
            --arg actor "$ACTOR" \
            --arg sha "$SHA" \
            '[
              {
                type: "header",
                text: { type: "plain_text", text: ":rocket: Schema PR 생성 완료", emoji: true }
              },
              {
                type: "section",
                fields: [
                  { type: "mrkdwn", text: "*Repository:*\n\($repo)" },
                  { type: "mrkdwn", text: "*Branch:*\n`\($branch)`" },
                  { type: "mrkdwn", text: "*Status:*\n`\($status)`" },
                  { type: "mrkdwn", text: "*PR:*\n<\($pr_url)|#\($pr_number)>" }
                ]
              },
              {
                type: "section",
                text: { type: "mrkdwn", text: "*변경된 디렉토리:*\n\($dirs)" }
              },
              {
                type: "section",
                text: { type: "mrkdwn", text: "*Commit Message:*\n_\($commit)_" }
              },
              {
                type: "context",
                elements: [
                  { type: "mrkdwn", text: "Author: *\($actor)* | " }
                ]
              }
            ]')
          
          if [ -n "$MENTIONS" ]; then
            BLOCKS=$(echo "$BLOCKS" | jq \
              --arg mentions "$MENTIONS" \
              '. + [{ type: "section", text: { type: "mrkdwn", text: "*:bell: 리뷰어:*\n\($mentions)" } }]')
          fi
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$(jq -n \
              --arg text ":rocket: [#${PR_NUMBER}] Schema PR 생성 완료${MENTIONS:+\n:bell: 리뷰어: $MENTIONS}" \
              --argjson blocks "$BLOCKS" \
              '{ text: $text, blocks: $blocks }')" \
            "$SLACK_WEBHOOK_URL"