name: build-and-deploy

on:
  push:
    tags:
      - 'deploy/**'
      - 'deploy_hotfix/**'

permissions:
  contents: write
jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v3

      - name: Get Hotfix Flag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          DEPLOY_TYPE=$(echo $TAG_NAME | cut -d'/' -f1)
          echo "DEPLOY_TYPE=$DEPLOY_TYPE" >> $GITHUB_ENV
          if [ "$DEPLOY_TYPE" == "deploy_hotfix" ]; then
            echo "HOTFIX=true" >> $GITHUB_ENV
          else
            echo "HOTFIX=false" >> $GITHUB_ENV
          fi

      - name: Get Branch Name
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BRANCH_NAME=$(echo $TAG_NAME | cut -d'/' -f2)
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Get Release Version
        id: get_release_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=$(echo $TAG_NAME | cut -d'/' -f3)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Run build script
        run: |
          bash scripts/build.sh

      - name: Compress build directory And Remove build directory
        run: |         
          LIB_DIR="build/lib"
          CORE_DIR="$LIB_DIR/lib-core"
          EXTRA_DIR="$LIB_DIR/lib-extra"
          SIZE_LIMIT=$((95 * 1024 * 1024)) # 95MB in bytes

          mkdir -p "$CORE_DIR" "$EXTRA_DIR"

          mapfile -t LIB_FILES < <(
            find "$LIB_DIR" -maxdepth 1 -type f -name "*.so*" -exec du -b {} + |
            sort -nr | awk '{print $1 ":" $2}'
          )

          total=0
          for entry in "${LIB_FILES[@]}"; do
            size=${entry%%:*}
            path=${entry##*:}
            base=$(basename "$path")

            if (( total + size <= SIZE_LIMIT )); then
              cp "$path" "$CORE_DIR/$base"
              total=$((total + size))
            else
              cp "$path" "$EXTRA_DIR/$base"
            fi
          done

          tar --exclude='lib' -czf build.tar.gz -C build .

          tar -czf lib-core.tar.gz -C "$CORE_DIR" .
          tar -czf lib-extra.tar.gz -C "$EXTRA_DIR" .

          echo "üì¶ ÏïïÏ∂ï Í≤∞Í≥º:"
          du -h build.tar.gz
          du -h lib-core.tar.gz
          du -h lib-extra.tar.gz

          rm -rf build
          cd $GITHUB_WORKSPACE

      - name: Clone release apps repository
        env:
          GH_TOKEN: ${{ secrets.RAINBOW_APPS_DEPLOY_TOKEN }}
        run: |
          git clone https://$GH_TOKEN@github.com/rainbow-mobile/rainbow-release-apps.git rainbow-release-apps
          cd rainbow-release-apps
          
          # ÏõêÌïòÎäî Î∏åÎûúÏπòÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† ÏóÜÏúºÎ©¥ empty Î∏åÎûúÏπòÏóêÏÑú ÏÉùÏÑ±
          if ! git ls-remote --heads origin ${{ env.BRANCH_NAME }} | grep ${{ env.BRANCH_NAME }}; then
            echo "Branch ${{ env.BRANCH_NAME }} not found, creating from empty branch"
            git checkout empty
            git checkout -b ${{ env.BRANCH_NAME }}
            git push origin ${{ env.BRANCH_NAME }}
          else
            git checkout ${{ env.BRANCH_NAME }}
          fi
          
          cd ..
          
      - name: Copy and commit build files
        env:
          GH_TOKEN: ${{ secrets.RAINBOW_APPS_DEPLOY_TOKEN }}
        run: |
          cd rainbow-release-apps
          APP_DIR="slamnav2"
          
          # ÎîîÎ†âÌÜ†Î¶¨Í∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† ÏÉùÏÑ±
          mkdir -p "$APP_DIR"

          # hotfix Ïó¨Î∂Ä ÌôïÏù∏
          HOTFIX_LINE=""
          if [ "${{ env.HOTFIX }}" == "true" ]; then
            HOTFIX_LINE=", \"hotfix\": true"
          fi

           # version.json ÌååÏùº ÏÉùÏÑ±/Í∞±Ïã†
          echo "{\"new_version\": \"${{ env.VERSION }}\"$HOTFIX_LINE}" > "$APP_DIR/version.json"
          
          # ÌòÑÏû¨ Î≤ÑÏ†Ñ ÎîîÎ†âÌÜ†Î¶¨ Ïàò ÌôïÏù∏ Î∞è Ï†ïÎ¶¨
          DIR_COUNT=$(ls -1 "$APP_DIR" | wc -l)
          if [ "$DIR_COUNT" -ge 10 ]; then
            OLDEST_DIR=$(ls -1 "$APP_DIR" | sort -V | head -n 1)
            rm -rf "$APP_DIR/$OLDEST_DIR"
          fi

          # ÏïïÏ∂ïÌååÏùº Ïù¥Îèô
          mkdir -p "$APP_DIR/${{ env.VERSION }}"
          mv ../build.tar.gz "$APP_DIR/"
          mv ../lib.tar.gz "$APP_DIR/"
          
          # ÏÉà Î≤ÑÏ†Ñ Î∞∞Ìè¨
          git config --global user.email "dfd1123@naver.com"
          git config --global user.name "dfd1123"
          git add .
          git commit -m "Release App: Slamnav2, Version: ${{ env.VERSION }}"
          git remote set-url origin https://$GH_TOKEN@github.com/rainbow-mobile/rainbow-release-apps.git
          git push origin ${{ env.BRANCH_NAME }}

      - name: Delete release tag
        if: always()
        env:
          GH_TOKEN: ${{ secrets.RAINBOW_APPS_DEPLOY_TOKEN }}
        run: |
          cd $GITHUB_WORKSPACE
          
          # ÌÉúÍ∑∏ ÏÇ≠Ï†ú
          git push origin --delete "${{ env.DEPLOY_TYPE }}/${{ env.BRANCH_NAME }}/${{ env.VERSION }}"