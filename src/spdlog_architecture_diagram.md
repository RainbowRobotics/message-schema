# AMR 시스템 spdlog 로깅 아키텍처 도식화

## 1. 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AMR 시스템 애플리케이션                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   COMM_RRS  │  │Navigation   │  │   Safety    │  │MissionCtrl  │        │
│  │   Module    │  │  Module     │  │   Module    │  │  Module     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
│         │                │                │                │               │
│         ▼                ▼                ▼                ▼               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   spdlog    │  │   spdlog    │  │   spdlog    │  │   spdlog    │        │
│  │   get()     │  │   get()     │  │   get()     │  │   get()     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
│         │                │                │                │               │
└─────────┼────────────────┼────────────────┼────────────────┼───────────────┘
          │                │                │                │
          ▼                ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        spdlog 레지스트리 (Registry)                         │
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │Communication│  │Navigation   │  │   Safety    │  │MissionCtrl  │        │
│  │   Logger    │  │   Logger    │  │   Logger    │  │   Logger    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
│         │                │                │                │               │
│         └────────────────┼────────────────┼────────────────┘               │
│                          │                │                                │
│                          ▼                ▼                                │
│                   ┌─────────────┐  ┌─────────────┐                        │
│                   │   System    │  │   기존      │                        │
│                   │   Logger    │  │   Logger    │                        │
│                   └─────────────┘  └─────────────┘                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2. 로거 구조 및 싱크 구성

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Logger 구조 (Logger Structure)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Communication Logger                             │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │   │
│  │  │  Console Sink   │  │  File Sink      │  │  JSON Formatter │     │   │
│  │  │  (stdout_color) │  │  (rotating)     │  │  (structured)   │     │   │
│  │  │  Level: INFO    │  │  Level: TRACE   │  │                 │     │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Navigation Logger                                │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │   │
│  │  │  Console Sink   │  │  File Sink      │  │  JSON Formatter │     │   │
│  │  │  (stdout_color) │  │  (rotating)     │  │  (structured)   │     │   │
│  │  │  Level: INFO    │  │  Level: TRACE   │  │                 │     │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Safety Logger                                    │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │   │
│  │  │  Console Sink   │  │  File Sink      │  │  JSON Formatter │     │   │
│  │  │  (stdout_color) │  │  (rotating)     │  │  (structured)   │     │   │
│  │  │  Level: INFO    │  │  Level: DEBUG   │  │                 │     │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3. 데이터 흐름 (Data Flow)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              데이터 흐름 (Data Flow)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐                                                           │
│  │   AMR App   │                                                           │
│  │             │                                                           │
│  │ ┌─────────┐ │                                                           │
│  │ │ COMM_RRS│ │                                                           │
│  │ │ Module  │ │                                                           │
│  │ └─────────┘ │                                                           │
│  └─────────────┘                                                           │
│         │                                                                   │
│         │ 1. 로그 이벤트 발생                                              │
│         ▼                                                                   │
│  ┌─────────────┐                                                           │
│  │   Logger    │                                                           │
│  │  Instance   │                                                           │
│  │             │                                                           │
│  │ ┌─────────┐ │                                                           │
│  │ │spdlog:: │ │                                                           │
│  │ │  get()  │ │                                                           │
│  │ └─────────┘ │                                                           │
│  └─────────────┘                                                           │
│         │                                                                   │
│         │ 2. 로거 검색                                                     │
│         ▼                                                                   │
│  ┌─────────────┐                                                           │
│  │   spdlog    │                                                           │
│  │  Registry   │                                                           │
│  │             │                                                           │
│  │ ┌─────────┐ │                                                           │
│  │ │Comm     │ │                                                           │
│  │ │Logger   │ │                                                           │
│  │ └─────────┘ │                                                           │
│  └─────────────┘                                                           │
│         │                                                                   │
│         │ 3. 로그 메시지 처리                                               │
│         ▼                                                                   │
│  ┌─────────────┐                                                           │
│  │   Sinks     │                                                           │
│  │             │                                                           │
│  │ ┌─────────┐ ┌─────────┐                                                 │
│  │ │Console  │ │ File    │                                                 │
│  │ │Sink     │ │ Sink    │                                                 │
│  │ └─────────┘ └─────────┘                                                 │
│  └─────────────┘                                                           │
│         │                │                                                 │
│         ▼                ▼                                                 │
│  ┌─────────────┐  ┌─────────────┐                                         │
│  │   Console   │  │   Log Files │                                         │
│  │   Output    │  │             │                                         │
│  │             │  │ comm.log    │                                         │
│  │             │  │ nav.log     │                                         │
│  │             │  │ safety.log  │                                         │
│  └─────────────┘  └─────────────┘                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 4. 구조화된 로깅 프로세스

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        구조화된 로깅 프로세스                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐                                                           │
│  │   Event     │                                                           │
│  │  발생       │                                                           │
│  └─────────────┘                                                           │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────┐                                                           │
│  │ JSON Payload│                                                           │
│  │ 생성        │                                                           │
│  │             │                                                           │
│  │ {           │                                                           │
│  │   "event_type": "MoveCommand",                                         │
│  │   "robot_id": "AMR-001",                                               │
│  │   "target_x": 10.5,                                                    │
│  │   "target_y": 20.3,                                                    │
│  │   "battery": 85.5                                                      │
│  │ }         │                                                           │
│  └─────────────┘                                                           │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────┐                                                           │
│  │ log_structured_│                                                       │
│  │ event() 호출 │                                                           │
│  └─────────────┘                                                           │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────┐                                                           │
│  │ JSON Formatter│                                                        │
│  │ 처리         │                                                           │
│  │             │                                                           │
│  │ {           │                                                           │
│  │   "timestamp": "2024-01-01T12:00:00.123Z",                            │
│  │   "level": "info",                                                     │
│  │   "logger": "Communication",                                           │
│  │   "message": "{\"event_type\":\"MoveCommand\",...}"                    │
│  │ }         │                                                           │
│  └─────────────┘                                                           │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────┐                                                           │
│  │   File      │                                                           │
│  │   저장      │                                                           │
│  └─────────────┘                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 5. 성능 최적화 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           성능 최적화 구조                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    컴파일 타임 최적화                                │   │
│  │                                                                     │   │
│  │  #define SPDLOG_ACTIVE_LEVEL SPDLOG_LEVEL_INFO                     │   │
│  │                                                                     │   │
│  │  SPDLOG_TRACE("This will be removed in release");                  │   │
│  │  SPDLOG_DEBUG("This will be removed in release");                  │   │
│  │  SPDLOG_INFO("This will be kept");                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    비동기 로깅                                      │   │
│  │                                                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│  │  │   Main      │  │   Log       │  │   Worker    │                │   │
│  │  │   Thread    │  │   Queue     │  │   Thread    │                │   │
│  │  │             │  │             │  │             │                │   │
│  │  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │                │   │
│  │  │ │Log Call │ │  │ │Message  │ │  │ │Process  │ │                │   │
│  │  │ │         │ │  │ │Queue    │ │  │ │Log      │ │                │   │
│  │  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │                │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    플러시 정책                                      │   │
│  │                                                                     │   │
│  │  spdlog::flush_on(spdlog::level::err);                             │   │
│  │  spdlog::flush_every(std::chrono::seconds(1));                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 6. 파일 구조 및 로그 관리

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           파일 구조 및 로그 관리                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  logs/                                                                      │
│  ├── comm.log                    # 통신 로그 (10MB, 5개 파일)              │
│  ├── comm.log.1                  # 로테이션된 파일들                        │
│  ├── comm.log.2                                                             │
│  ├── comm.log.3                                                             │
│  ├── comm.log.4                                                             │
│  ├── navigation.log              # 내비게이션 로그                          │
│  ├── navigation.log.1                                                        │
│  ├── navigation.log.2                                                        │
│  ├── safety.log                  # 안전 시스템 로그                         │
│  ├── safety.log.1                                                           │
│  ├── mission.log                 # 미션 제어 로그                           │
│  ├── mission.log.1                                                          │
│  ├── system.log                  # 시스템 전체 로그                         │
│  ├── system.log.1                                                           │
│  └── log_styles.css              # HTML 로그 스타일                         │
│                                                                             │
│  snlog/                                                                     │
│  ├── 20240101_LidarDetectionRange.log    # 기존 SEM 로그                   │
│  └── sem_temperature_log.log              # 온도 로그                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 7. 모듈별 로그 레벨 설정

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           모듈별 로그 레벨 설정                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │Communication│  │Navigation   │  │   Safety    │  │MissionCtrl  │        │
│  │             │  │             │  │             │  │             │        │
│  │ Console:    │  │ Console:    │  │ Console:    │  │ Console:    │        │
│  │   INFO      │  │   INFO      │  │   INFO      │  │   INFO      │        │
│  │             │  │             │  │             │  │             │        │
│  │ File:       │  │ File:       │  │ File:       │  │ File:       │        │
│  │   TRACE     │  │   TRACE     │  │   DEBUG     │  │   INFO      │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐                                          │
│  │   System    │  │   기존      │                                          │
│  │   Logger    │  │   Logger    │                                          │
│  │             │  │             │                                          │
│  │ Console:    │  │ Console:    │                                          │
│  │   INFO      │  │   INFO      │                                          │
│  │             │  │             │                                          │
│  │ File:       │  │ File:       │                                          │
│  │   INFO      │  │   INFO      │                                          │
│  └─────────────┘  └─────────────┘                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

이 도식화를 통해 spdlog 기반 로깅 시스템의 전체적인 구조와 데이터 흐름, 그리고 각 모듈 간의 관계를 명확하게 이해할 수 있습니다.
